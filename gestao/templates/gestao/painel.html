{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>6º BPM - Gestão de Custódia</title>
    <style>
        body { background-color: #f4f7f6; font-family: 'Segoe UI', sans-serif; }
        .bg-pmpr { background-color: #1a3a2a; }
        .card-shadow { border: none; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .nav-tabs .nav-link { color: #495057; font-weight: 500; border: none; padding: 1rem; cursor: pointer; }
        .nav-tabs .nav-link.active { border-bottom: 3px solid #1a3a2a; color: #1a3a2a; background: none; }
        .header-oficial { background: white; border-bottom: 3px solid #1a3a2a; padding: 12px 0; }
        .search-bar { border-radius: 20px 0 0 20px; padding-left: 40px; }
        .search-icon { position: absolute; left: 15px; top: 10px; color: #6c757d; z-index: 10; }
        .badge-vara { background-color: #f8f9fa; color: #1a3a2a; border-left: 4px solid #1a3a2a; font-weight: bold; }
    </style>
</head>
<body>

{{ labels_json|json_script:"labels-data" }}
{{ valores_json|json_script:"valores-data" }}

<header class="header-oficial mb-4 shadow-sm">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="{% static 'img/brasao_pmpr.svg' %}" style="height: 80px;" class="me-3">
            <div>
                <h5 class="mb-0 fw-bold">6º BATALHÃO DE POLÍCIA MILITAR</h5>
                <small class="text-muted">Gestão de Custódia - Cascavel/PR</small>
            </div>
        </div>
        
        <div class="w-50 px-4 text-center">
            <form method="GET" action="{% url 'painel' %}" class="input-group">
                <div class="position-relative flex-grow-1">
                    <i class="bi bi-search search-icon"></i>
                    <input type="text" name="busca_bou" class="form-control search-bar" placeholder="Buscar por nº do BOU..." value="{{ busca_termo }}">
                </div>
                <button class="btn btn-success px-4" type="submit">Pesquisar</button>
            </form>
        </div>

        <div class="d-flex gap-2">
            <a href="{% url 'relatorio_final' %}" target="_blank" class="btn btn-sm btn-outline-dark fw-bold"><i class="bi bi-printer"></i> GESTÃO</a>
            <a href="{% url 'relatorio_queima' %}" target="_blank" class="btn btn-sm btn-outline-danger fw-bold"><i class="bi bi-fire"></i> QUEIMA</a>
        </div>
    </div>
</header>

<div class="container">
    {% if messages %}{% for m in messages %}
        <div class="alert alert-{{ m.tags }} alert-dismissible fade show border-0 shadow-sm border-start border-4">
            {{ m }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    {% endfor %}{% endif %}

    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card card-shadow p-3 h-100 text-center">
                <h6 class="fw-bold mb-3 text-muted small uppercase">Estoque Físico (Aguardando Queima)</h6>
                <div style="height:200px;"><canvas id="graficoDrogas"></canvas></div>
            </div>
        </div>

   <div class="col-md-8">
    <div class="card card-shadow p-4 h-100 border-top border-4 border-success">
        <h5 class="fw-bold text-success mb-3 small"><i class="bi bi-plus-circle"></i> NOVO REGISTRO DE APREENSÃO</h5>
        <form method="POST" action="{% url 'registrar' %}" id="form-cadastro">
            {% csrf_token %}
            
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">BOU</label>
                    <input type="text" name="bou" id="input_bou" class="form-control fw-bold" value="2026/" required>
                </div>
                <div class="col-md-5">
                    <label class="small fw-bold text-muted">Nº Processo (Projudi)</label>
                    <input type="text" name="processo" id="input_projudi" class="form-control" placeholder="0000000-00.0000.8.16.0000">
                </div>
                <div class="col-md-4">
                    <label class="small fw-bold text-muted">Vara Criminal</label>
                    <select name="vara" class="form-select" required>
                        <option value="" disabled selected>Selecionar...</option>
                        <option value="VARA_01">1ª Vara Criminal</option>
                        <option value="VARA_02">2ª Vara Criminal</option>
                        <option value="VARA_03">3ª Vara Criminal</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="small fw-bold text-muted">Policial Responsável</label>
                    <input type="text" name="policial_nome" class="form-control" placeholder="NOME COMPLETO" required>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">Graduação</label>
                    <select name="policial_graduacao" class="form-select">
                        <option value="SD">Soldado</option>
                        <option value="CB">Cabo</option>
                        <option value="3SGT">3º Sargento</option>
                        <option value="2SGT">2º Sargento</option>
                        <option value="1SGT">1º Sargento</option>
                        <option value="SUB">Subtenente</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="small fw-bold text-muted">RG Policial</label>
                    <input type="text" name="rg_policial" class="form-control" placeholder="Apenas números" maxlength="15" required>
                </div>
            </div>
            
            <hr class="my-4">
            
            <div id="container-noticiados">
                <div class="bloco-noticiado border p-3 mb-3 bg-light rounded shadow-sm">
                    <div class="row g-2">
                        <div class="col-md-4">
                            <label class="small fw-bold">Nome do Noticiado</label>
                            <input type="text" name="noticiado_nome" class="form-control uppercase-input" placeholder="NOME COMPLETO" required>
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold">Substância</label>
                            <select name="substancia" class="form-select select-substancia">
                                {% for val, nome in drogas_lista %}
                                <option value="{{ val }}">{{ nome }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="small fw-bold">Peso/Qtd</label>
                            <div class="input-group">
                                <input type="text" name="peso_estimado" class="form-control mask-peso" placeholder="0,00">
                                <select name="unidade" class="form-select select-unidade" style="max-width: 60px;">
                                    <option value="G">g</option>
                                    <option value="U">un</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="small fw-bold">Nº Lacre/Vestígio</label>
                            <input type="text" name="num_lacre" class="form-control" placeholder="Lacre">
                        </div>
                    </div>
                </div>
            </div>

            <div class="d-flex justify-content-between mt-3">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="adicionarNoticiado()">
                    <i class="bi bi-person-plus"></i> + Noticiado/Droga
                </button>
                <button type="submit" class="btn btn-success fw-bold px-5">SALVAR REGISTRO</button>
            </div>
        </form>
    </div>
</div>

    </div>

    <ul class="nav nav-tabs mb-4 bg-white rounded shadow-sm px-3 border-0">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-pendentes"><i class="bi bi-clock-history"></i> Conferência <span class="badge bg-danger">{{ pendentes.count }}</span></button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cofre"><i class="bi bi-safe"></i> No Cofre <span class="badge bg-warning text-dark">{{ no_cofre.count }}</span></button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-queima"><i class="bi bi-fire"></i> Pronto Queima <span class="badge bg-success">{{ prontos.count }}</span></button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-historico"><i class="bi bi-archive"></i> Histórico / Varas</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-pendentes">
    <div class="row">
        {% for item in pendentes %}
        <div class="col-md-4 mb-3">
            <div class="card p-3 shadow-sm border-start border-4 border-danger">
                <h6>BOU: {{ item.noticiado.ocorrencia.bou }}</h6>
                <p class="mb-1">Réu: <strong>{{ item.noticiado.nome|upper }}</strong></p>
                <p class="small text-muted mb-2">Substância: {{ item.get_substancia_display }} ({{ item.peso_estimado }} {{ item.get_unidade_display }})</p>
                
                <button type="button" class="btn btn-sm btn-success fw-bold" data-bs-toggle="modal" data-bs-target="#modalConferir{{ item.id }}">
                    <i class="bi bi-shield-check"></i> CONFERIR
                </button>
            </div>
        </div>

        <div class="modal fade" id="modalConferir{{ item.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form class="modal-content" method="POST" action="{% url 'conferir' item.id %}">
            {% csrf_token %}
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Conferência - BOU: {{ item.noticiado.ocorrencia.bou }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
    <div class="alert alert-light border shadow-sm small">
        <div class="row">
            <div class="col-6"><strong>BOU:</strong> {{ item.noticiado.ocorrencia.bou }}</div>
            <div class="col-6"><strong>Processo:</strong> {{ item.noticiado.ocorrencia.processo }}</div>
            <div class="col-6"><strong>Noticiado:</strong> {{ item.noticiado.nome }}</div>
            <div class="col-6"><strong>Lacre Inicial:</strong> {{ item.numero_vestigio }}</div>
        </div>
    </div>

    <div class="row g-3 mt-1">
        <div class="col-md-6">
            <label class="fw-bold small">Substância</label>
            <input type="text" class="form-control" value="{{ item.get_substancia_display }}" disabled>
        </div>
        <div class="col-md-6">
            <label class="fw-bold small">Peso Registrado</label>
            <input type="text" class="form-control" value="{{ item.peso_estimado }} {{ item.get_unidade_display }}" disabled>
        </div>
        <div class="col-md-12">
            <hr>
            <label class="fw-bold small text-success">PESO REAL (Balança)</label>
            <div class="input-group">
                <input type="text" name="peso_real" class="form-control mask-peso" placeholder="0,00" required>
                <span class="input-group-text">{{ item.get_unidade_display }}</span>
            </div>
        </div>
        <div class="col-md-6">
            <label class="fw-bold small">Caixa (Lote)</label>
            <select name="lote_id" class="form-select" required>
                {% for lote in todos_lotes %}
                    <option value="{{ lote.id }}">{{ lote.identificador }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-6">
            <label class="fw-bold small">Posição/Sacola</label>
            <input type="text" name="posicao_sacola" class="form-control" placeholder="Ex: FEV-01" required>
        </div>
    </div>
</div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-success px-4 fw-bold">FINALIZAR CONFERÊNCIA</button>
            </div>
        </form>
    </div>
</div>
        {% empty %}
        <div class="col-12 text-center py-5 text-muted">Nenhuma pendência de conferência.</div>
        {% endfor %}
    </div>
</div>

        <div class="tab-pane fade" id="tab-cofre">
    <div class="card card-shadow overflow-hidden">
        <table class="table table-hover align-middle mb-0 text-center">
            <thead class="bg-light">
                <tr>
                    <th>Caixa/Posição</th>
                    <th>BOU / Processo</th>
                    <th>Noticiado</th>
                    <th>Substância</th>
                    <th>Peso</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for item in no_cofre %}
                <tr>
                    <td>
                        <span class="badge bg-primary">CX: {{ item.lote.identificador }}</span><br>
                        <small class="text-muted fw-bold">{{ item.posicao_sacola }}</small>
                    </td>
                    <td class="text-start">
    <div class="d-flex flex-column">
        <span class="badge bg-dark mb-1" style="width: fit-content;">
            BOU: {{ item.noticiado.ocorrencia.bou }}
        </span>
        <small class="text-muted fw-bold">
            <i class="bi bi-file-earmark-text"></i> {{ item.noticiado.ocorrencia.processo }}
        </small>
    </div>
</td>
                    <td>{{ item.noticiado.nome|upper }}</td>
                    <td>{{ item.get_substancia_display }}</td>
                    <td class="fw-bold">{{ item.peso_real }} {{ item.get_unidade_display }}</td>
                    <td>
                        <button class="btn btn-sm btn-success fw-bold" data-bs-toggle="modal" data-bs-target="#oficio{{item.id}}">
                            <i class="bi bi-file-earmark-check"></i>
                        </button>
                    </td>
                </tr>

                <div class="modal fade" id="oficio{{item.id}}" tabindex="-1">
                    <form class="modal-dialog modal-content" method="POST" action="{% url 'vincular_oficio' item.id %}">
                        {% csrf_token %}
                        <div class="modal-header bg-success text-white">
                            <h5 class="modal-title">Autorização Judicial - {{ item.noticiado.ocorrencia.bou }}</h5>
                        </div>
                        <div class="modal-body">
                            <label class="fw-bold small">Nº do Ofício / Decisão:</label>
                            <input type="text" name="n_oficio" class="form-control" placeholder="Ex: 123/2026-1VC" required>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="btn btn-success w-100">AUTORIZAR QUEIMA</button>
                        </div>
                    </form>
                </div>
                {% endfor %} </tbody>
        </table>
    </div>
</div>

        <div class="tab-pane fade" id="tab-queima">
    {% regroup prontos by lote as lotes_list %}
    
    {% for lote in lotes_list %}
        <div class="card card-shadow mb-4 border-start border-4 border-danger">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h6 class="fw-bold mb-0 text-danger">LOTE: {{ lote.grouper.identificador }}</h6>
                
                <form method="POST" action="{% url 'finalizar_lote' %}" onsubmit="return confirm('Confirmar incineração definitiva?')">
                    {% csrf_token %}
                    <input type="hidden" name="lote_id" value="{{ lote.grouper.id }}">
                    <button class="btn btn-danger btn-sm fw-bold">CONCLUIR INCINERAÇÃO</button>
                </form>
            </div>
            <table class="table table-sm mb-0">
                <thead><tr class="text-center"><th>BOU</th><th>Ofício</th><th>Substância</th><th>Peso</th></tr></thead>
                <tbody>
                    {% for item in lote.list %}
                    <tr class="text-center">
                        <td class="fw-bold">{{ item.noticiado.ocorrencia.bou }}</td>
                        <td>{{ item.n_oficio }}</td>
                        <td>{{ item.get_substancia_display }}</td>
                        <td>{{ item.peso_real }} {{ item.get_unidade_display }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% empty %}
        <div class="text-center py-5 text-muted">Nenhum lote pronto para queima.</div>
    {% endfor %}
</div>

        <div class="tab-pane fade" id="tab-historico">
            <div class="card card-shadow p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0"><i class="bi bi-archive"></i> Histórico de Incineração</h5>
                    <a href="{% url 'relatorio_forum' %}" target="_blank" class="btn btn-dark fw-bold shadow-sm"><i class="bi bi-printer"></i> IMPRIMIR TUDO (GERAL)</a>
                </div>
                {% regroup incinerados by noticiado.ocorrencia.vara as vara_list %}
                {% for v in vara_list %}
                <div class="mb-5 shadow-sm border rounded overflow-hidden">
                    <div class="p-3 bg-light border-bottom"><span class="fw-bold fs-5 text-primary"><i class="bi bi-bank"></i> {{ v.list.0.noticiado.ocorrencia.get_vara_display|upper }}</span></div>
                    <table class="table table-hover mb-0">
                        <tbody>
                            {% for item in v.list %}
                            <tr class="small">
                                <td>{{ item.data_conferencia|date:"d/m/Y" }}</td>
                                <td class="fw-bold">{{ item.noticiado.ocorrencia.processo }}</td>
                                <td>{{ item.noticiado.nome|upper }}</td>
                                <td>{{ item.noticiado.ocorrencia.bou }}</td>
                                <td>{{ item.get_substancia_display }}</td>
                                <td class="fw-bold">{{ item.peso_real }} {{ item.get_unidade_display }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endfor %}
            </div>
        </div>
    </div> </div> 
    
<script>
    // --- MÁSCARA BOU ---
    const bou = document.getElementById('input_bou');
    const prefixo = "2026/";
    bou.addEventListener('input', function() {
        if (!this.value.startsWith(prefixo)) this.value = prefixo;
    });
    bou.addEventListener('keydown', function(e) {
        if (this.selectionStart <= prefixo.length && (e.key === 'Backspace' || e.key === 'Delete')) {
            e.preventDefault();
        }
    });

    // --- MÁSCARA PROJUDI ---
    document.getElementById('input_projudi').addEventListener('input', function(e) {
        let v = e.target.value.replace(/\D/g, "");
        if (v.length > 20) v = v.slice(0, 20);
        v = v.replace(/^(\d{7})(\d)/, "$1-$2").replace(/-(\d{2})(\d)/, "-$1.$2")
             .replace(/\.(\d{4})(\d)/, ".$1.$2").replace(/\.(\d{1})(\d)/, ".$1.$2")
             .replace(/\.(\d{2})(\d)/, ".$1.$2");
        e.target.value = v;
    });

    // --- DELEGAÇÃO DE EVENTOS (Peso, Maiúsculas e RG) ---
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('mask-peso')) {
            let v = e.target.value.replace(/\D/g, '');
            v = (v / 100).toFixed(2).replace('.', ',');
            e.target.value = v;
        }
        if (e.target.classList.contains('uppercase-input')) {
            e.target.value = e.target.value.toUpperCase();
        }
        if (e.target.name === 'rg_policial') {
            e.target.value = e.target.value.replace(/\D/g, '');
        }
    });

    // --- REGRA PÉ DE MACONHA ---
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('select-substancia')) {
            const row = e.target.closest('.row');
            const unidade = row.querySelector('.select-unidade');
            if (e.target.options[e.target.selectedIndex].text.toUpperCase().includes("PÉ")) {
                unidade.value = "U";
            } else {
                unidade.value = "G";
            }
        }
    });

    // --- FUNÇÃO ADICIONAR NOTICIADO (Corrigida) ---
    function adicionarNoticiado() {
        const container = document.getElementById('container-noticiados');
        const primeiroBloco = container.querySelector('.bloco-noticiado');
        const novoBloco = primeiroBloco.cloneNode(true);

        // Limpa campos
        novoBloco.querySelectorAll('input').forEach(i => i.value = '');
        novoBloco.querySelectorAll('select').forEach(s => s.selectedIndex = 0);

        // Adiciona botão de remover
        const btnRemoverContainer = document.createElement('div');
        btnRemoverContainer.className = 'text-end mt-2 btn-remover-container';
        btnRemoverContainer.innerHTML = `
            <button type="button" class="btn btn-sm btn-danger" style="font-size: 10px; padding: 2px 5px;" 
                    onclick="this.closest('.bloco-noticiado').remove()">
                <i class="bi bi-trash"></i> REMOVER ITEM
            </button>`;
        novoBloco.appendChild(btnRemoverContainer);
        
        container.appendChild(novoBloco);
    }

    // --- GRÁFICO ---
    document.addEventListener("DOMContentLoaded", function() {
        renderizarGrafico();
    });

    function renderizarGrafico() {
        const labelsRaw = document.getElementById('labels-data').textContent;
        const valoresRaw = document.getElementById('valores-data').textContent;
        
        if (!labelsRaw || !valoresRaw) return;

        const labels = JSON.parse(labelsRaw.replace(/^"|"$/g, '').replace(/\\"/g, '"'));
        const valores = JSON.parse(valoresRaw.replace(/^"|"$/g, '').replace(/\\"/g, '"'));

        const canvas = document.getElementById('graficoDrogas');
        if (!canvas) return;

        new Chart(canvas.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: valores,
                    backgroundColor: ['#1a3a2a', '#198754', '#dc3545', '#ffc107', '#0d6efd'],
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } },
                cutout: '70%'
            }
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

{% if messages %}
    {% for m in messages %}
        {% if 'abrir_recibo' in m.tags %}
            <script>
                // O conteúdo da mensagem (m.message) é apenas o ID
                window.open("{% url 'gerar_recibo' m.message %}", '_blank');
            </script>
        {% endif %}
    {% endfor %}
{% endif %}

</body>
</html>